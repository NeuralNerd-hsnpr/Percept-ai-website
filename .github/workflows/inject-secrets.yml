name: Inject Secrets & Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Inject secrets into careers.html
      env:
        CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
        FORMSPREE_JDS_FORM_ID: ${{ secrets.FORMSPREE_JDS_FORM_ID }}
        FORMSPREE_SDS_FORM_ID: ${{ secrets.FORMSPREE_SDS_FORM_ID }}
        FORMSPREE_MLOPS_FORM_ID: ${{ secrets.FORMSPREE_MLOPS_FORM_ID }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
      run: |
        # Replace Cloudinary placeholder
        sed -i "s|'YOUR_CLOUDINARY_CLOUD_NAME'|'${CLOUDINARY_CLOUD_NAME}'|g" careers.html
        
        # Replace individual Form ID placeholders
        sed -i "s|'YOUR_FORMSPREE_JDS_FORM_ID'|'${FORMSPREE_JDS_FORM_ID}'|g" careers.html
        sed -i "s|'YOUR_FORMSPREE_SDS_FORM_ID'|'${FORMSPREE_SDS_FORM_ID}'|g" careers.html
        sed -i "s|'YOUR_FORMSPREE_MLOPS_FORM_ID'|'${FORMSPREE_MLOPS_FORM_ID}'|g" careers.html
        
        # Replace email placeholder
        sed -i "s|'your-email@gmail.com'|'${RECIPIENT_EMAIL}'|g" careers.html
        
        # Verify the substitutions were made
        grep -q "${CLOUDINARY_CLOUD_NAME}" careers.html && echo "✓ Cloudinary secret injected"
        grep -q "${FORMSPREE_JDS_FORM_ID}" careers.html && echo "✓ JDS Form ID injected"
        grep -q "${FORMSPREE_SDS_FORM_ID}" careers.html && echo "✓ SDS Form ID injected"
        grep -q "${FORMSPREE_MLOPS_FORM_ID}" careers.html && echo "✓ MLOps Form ID injected"
        grep -q "${RECIPIENT_EMAIL}" careers.html && echo "✓ Email secret injected"
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        cname: percept-ai.co.uk
